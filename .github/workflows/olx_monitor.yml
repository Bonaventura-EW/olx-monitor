name: OLX Monitor ‚Äì codzienny raport

on:
  schedule:
    - cron: "0 7 * * *"   # 09:00 czasu polskiego (UTC+2)
  workflow_dispatch:
    inputs:
      force_email:
        description: 'Wymu≈õ wysy≈Çkƒô e-maila (niezale≈ºnie od dnia tygodnia)'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repozytorium
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ustaw Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Zainstaluj zale≈ºno≈õci
        run: pip install -r requirements.txt
        continue-on-error: false

      - name: Przygotuj katalogi na skrypty
        run: |
          mkdir -p .github/scripts
          cp inject_dashboard.py .github/scripts/ 2>/dev/null || true

      - name: Uruchom OLX Monitor (scraping) ‚Äì attempt 1
        id: scrape_1
        run: python olx_monitor.py
        continue-on-error: true

      - name: Uruchom OLX Monitor (scraping) ‚Äì attempt 2 (retry)
        id: scrape_2
        if: steps.scrape_1.outcome == 'failure'
        run: |
          echo "‚ö†  Pierwszy attempt nie powi√≥d≈Ç siƒô ‚Äì retry..."
          sleep 30
          python olx_monitor.py
        continue-on-error: true

      - name: Sprawd≈∫ czy scraping powi√≥d≈Ç siƒô
        if: steps.scrape_1.outcome == 'failure' && steps.scrape_2.outcome == 'failure'
        run: |
          echo "‚ùå OLX Monitor nie powi√≥d≈Ç siƒô po 2 pr√≥bach"
          exit 1

      - name: Weryfikuj czy pliki danych zosta≈Çy utworzone
        run: |
          if [ ! -f data/last_run.json ]; then
            echo "‚ùå B≈ÇƒÖd: brak data/last_run.json ‚Äì scraping nie powi√≥d≈Ç siƒô"
            exit 1
          fi
          if [ ! -f data/price_history.json ]; then
            echo "‚ùå B≈ÇƒÖd: brak data/price_history.json"
            exit 1
          fi
          echo "‚úÖ Wszystkie pliki danych zosta≈Çy utworzone"

      - name: Wy≈õlij tygodniowy raport e-mail (poniedzia≈Çek)
        run: |
          DAY=$(date +%u)
          FORCE="${{ github.event.inputs.force_email }}"
          if [ "$DAY" = "1" ] || [ "$FORCE" = "true" ]; then
            echo "üìß Wysy≈Çam tygodniowy raport e-mail..."
            python email_report.py
          else
            echo "‚è≠  Nie poniedzia≈Çek (dzie≈Ñ $DAY) ‚Äì pomijam e-mail."
          fi
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        continue-on-error: true

      - name: Poka≈º wyniki (summary)
        if: always()
        run: |
          echo "## üìä OLX Monitor ‚Äì wyniki $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          if [ -f data/last_run.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat data/last_run.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö† Brak data/last_run.json" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Zaktualizuj dashboard (wstrzyknij ≈õwie≈ºe dane do HTML)
        run: |
          # WALIDACJA: Sprawd≈∫ istnienie plik√≥w przed przetwarzaniem
          if [ ! -f olx_dashboard.html ]; then
            echo "‚ö†  Brak olx_dashboard.html ‚Äì pomijam aktualizacjƒô dashboard"
            exit 0
          fi
          
          if [ ! -f data/price_history.json ]; then
            echo "‚ö†  Brak data/price_history.json ‚Äì dashboard bez wstrzykniƒôtych danych"
            exit 0
          fi

          # Uruchom skrypt wstrzykiwania danych
          python .github/scripts/inject_dashboard.py

      - name: Zapisz dane do repozytorium
        run: |
          git config user.name  "OLX Monitor Bot"
          git config user.email "bot@github-actions"
          git add data/olx_monitoring.xlsx     || true
          git add data/price_history.json      || true
          git add data/profiles_state.json     || true
          git add data/last_run.json           || true
          git add olx_dashboard.html           || true
          
          # Sprawd≈∫ czy sƒÖ zmiany
          if git diff --cached --quiet; then
            echo "‚Ñπ  Brak zmian do zapisania"
            exit 0
          fi
          
          git commit -m "üìä OLX Monitor $(date +'%Y-%m-%d %H:%M')"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Push z retry
          for attempt in 1 2 3; do
            echo "Push attempt $attempt..."
            if git push origin main; then
              echo "‚úÖ Push powi√≥d≈Ç siƒô"
              exit 0
            fi
            if [ $attempt -lt 3 ]; then
              echo "‚ö†  Push failed, retry za 10s..."
              sleep 10
            fi
          done
          
          echo "‚ùå Push failed po 3 pr√≥bach"
          exit 1

      - name: Notyfikacja w przypadku b≈Çƒôdu
        if: failure()
        run: |
          echo "‚ùå Workflow nie powi√≥d≈Ç siƒô"
          echo "Sprawd≈∫ logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
