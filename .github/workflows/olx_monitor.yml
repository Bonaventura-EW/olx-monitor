name: OLX Monitor â€“ codzienny raport

on:
  schedule:
    - cron: "0 7 * * *"   # 09:00 czasu polskiego (UTC+2)
  workflow_dispatch:
    inputs:
      force_email:
        description: 'WymuÅ› wysyÅ‚kÄ™ e-maila (niezaleÅ¼nie od dnia tygodnia)'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repozytorium
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ustaw Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Zainstaluj zaleÅ¼noÅ›ci
        run: pip install -r requirements.txt
        continue-on-error: false

      - name: Uruchom OLX Monitor (scraping) â€“ attempt 1
        id: scrape_1
        run: python olx_monitor.py
        continue-on-error: true

      - name: Uruchom OLX Monitor (scraping) â€“ attempt 2 (retry)
        id: scrape_2
        if: steps.scrape_1.outcome == 'failure'
        run: |
          echo "âš   Pierwszy attempt nie powiÃ³dÅ‚ siÄ™ â€“ retry..."
          sleep 30
          python olx_monitor.py
        continue-on-error: true

      - name: SprawdÅº czy scraping powiÃ³dÅ‚ siÄ™
        if: steps.scrape_1.outcome == 'failure' && steps.scrape_2.outcome == 'failure'
        run: |
          echo "âŒ OLX Monitor nie powiÃ³dÅ‚ siÄ™ po 2 prÃ³bach"
          exit 1

      - name: Weryfikuj czy pliki danych zostaÅ‚y utworzone
        run: |
          if [ ! -f data/last_run.json ]; then
            echo "âŒ BÅ‚Ä…d: brak data/last_run.json â€“ scraping nie powiÃ³dÅ‚ siÄ™"
            exit 1
          fi
          if [ ! -f data/price_history.json ]; then
            echo "âŒ BÅ‚Ä…d: brak data/price_history.json"
            exit 1
          fi
          echo "âœ… Wszystkie pliki danych zostaÅ‚y utworzone"

      - name: WyÅ›lij tygodniowy raport e-mail (poniedziaÅ‚ek)
        run: |
          DAY=$(date +%u)
          FORCE="${{ github.event.inputs.force_email }}"
          if [ "$DAY" = "1" ] || [ "$FORCE" = "true" ]; then
            echo "ğŸ“§ WysyÅ‚am tygodniowy raport e-mail..."
            python email_report.py
          else
            echo "â­  Nie poniedziaÅ‚ek (dzieÅ„ $DAY) â€“ pomijam e-mail."
          fi
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        continue-on-error: true

      - name: PokaÅ¼ wyniki (summary)
        if: always()
        run: |
          echo "## ğŸ“Š OLX Monitor â€“ wyniki $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          if [ -f data/last_run.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat data/last_run.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš  Brak data/last_run.json" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Zaktualizuj dashboard (wstrzyknij Å›wieÅ¼e dane do HTML)
        run: |
          # WALIDACJA: SprawdÅº istnienie plikÃ³w przed przetwarzaniem
          if [ ! -f olx_dashboard.html ]; then
            echo "âš   Brak olx_dashboard.html â€“ pomijam aktualizacjÄ™ dashboard"
            exit 0
          fi
          
          if [ ! -f data/price_history.json ]; then
            echo "âš   Brak data/price_history.json â€“ dashboard bez wstrzykniÄ™tych danych"
            exit 0
          fi

          python - << 'PYEOF'
import json, re, os, sys

try:
    # Wczytaj price_history
    with open("data/price_history.json", "r", encoding="utf-8") as f:
        history = json.load(f)
    print(f"âœ“ Wczytano price_history.json: {len(history)} ogÅ‚oszeÅ„")
except Exception as e:
    print(f"âŒ BÅ‚Ä…d wczytywania price_history.json: {e}")
    sys.exit(1)

try:
    # Wczytaj market_total z last_run.json
    market_total = None
    if os.path.exists("data/last_run.json"):
        with open("data/last_run.json", "r", encoding="utf-8") as f:
            last_run = json.load(f)
        market_total = last_run.get("market_total")
    print(f"âœ“ Market total: {market_total}")
except Exception as e:
    print(f"âš   BÅ‚Ä…d wczytywania last_run.json: {e}")
    market_total = None

try:
    with open("olx_dashboard.html", "r", encoding="utf-8") as f:
        html = f.read()
    print(f"âœ“ Wczytano olx_dashboard.html: {len(html)} bajtÃ³w")
except Exception as e:
    print(f"âŒ BÅ‚Ä…d wczytywania olx_dashboard.html: {e}")
    sys.exit(1)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Wstrzyknij PRICE_HISTORY
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
inject_ph = f"window.__PRICE_HISTORY__ = {json.dumps(history, ensure_ascii=False)};"

if "window.__PRICE_HISTORY__" in html:
    # IstniejÄ…cy marker â€” zastÄ…p
    pattern = r"window\.__PRICE_HISTORY__\s*=\s*(?:\{.*?\}|null);?"
    html_new = re.sub(pattern, inject_ph, html, count=1, flags=re.DOTALL)
    if html_new != html:
        html = html_new
        print("âœ“ Price history zaktualizowana (istniejÄ…cy marker)")
    else:
        print("âš   Nie udaÅ‚o siÄ™ zaktualizowaÄ‡ istniejÄ…cego markera â€” dodajÄ™ nowy")
        # Fallback: dodaj przed </script>
        if "</script>" in html:
            html = html.replace("</script>", f"\n{inject_ph}\n</script>", 1)
            print("âœ“ Price history dodana (fallback)")
else:
    # Nowy marker â€” dodaj
    if "</script>" in html:
        html = html.replace("</script>", f"\n{inject_ph}\n</script>", 1)
        print("âœ“ Price history dodana (nowy marker)")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Wstrzyknij MARKET_TOTAL
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if market_total is not None:
    inject_mt = f"window.__MARKET_TOTAL__ = {market_total};"
    
    if "window.__MARKET_TOTAL__" in html:
        html = re.sub(
            r"window\.__MARKET_TOTAL__\s*=\s*\d+;?",
            inject_mt,
            html,
            count=1
        )
        print("âœ“ Market total zaktualizowany")
    else:
        if "</script>" in html:
            html = html.replace("</script>", f"\n{inject_mt}\n</script>", 1)
            print("âœ“ Market total dodany")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Wstrzyknij LAST_RUN (czas ostatniego skanu)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    if os.path.exists("data/last_run.json"):
        with open("data/last_run.json", "r", encoding="utf-8") as f_lr:
            last_run_data = json.load(f)
        run_at = last_run_data.get("run_at", "")
        if run_at:
            inject_lr = f'window.__LAST_RUN__ = "{run_at}";'
            if "window.__LAST_RUN__" in html:
                html = re.sub(
                    r'window\.__LAST_RUN__\s*=\s*"[^"]*";?',
                    inject_lr,
                    html,
                    count=1
                )
                print("âœ“ Last run zaktualizowany")
            else:
                if "</script>" in html:
                    html = html.replace("</script>", f"\n{inject_lr}\n</script>", 1)
                    print("âœ“ Last run dodany")
except Exception as e:
    print(f"âš   BÅ‚Ä…d wstrzykiwania LAST_RUN: {e}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Wstrzyknij PROFILES_DATA (obsÅ‚uga wieloliniowego JSON)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    if os.path.exists("data/profiles_state.json"):
        with open("data/profiles_state.json", "r", encoding="utf-8") as f_ps:
            profiles_state = json.load(f_ps)
        inject_pd = f"window.__PROFILES_DATA__ = {json.dumps(profiles_state, ensure_ascii=False)};"
        
        if "window.__PROFILES_DATA__" in html:
            # Najlepiej: znajdÅº dokÅ‚adne granice zmiennej
            start = html.find("window.__PROFILES_DATA__ = ")
            if start != -1:
                # Szukaj koÅ„ca (";")
                search_from = start + len("window.__PROFILES_DATA__ = ")
                end = html.find(";", search_from)
                if end != -1:
                    # ZamieÅ„ zawartoÅ›Ä‡ miÄ™dzy "= " a ";"
                    html = html[:start] + f"window.__PROFILES_DATA__ = {json.dumps(profiles_state, ensure_ascii=False)};" + html[end+1:]
                    print("âœ“ Profiles data zaktualizowana (precyzyjnie)")
                else:
                    print("âš   Nie znaleziono koÅ„ca PROFILES_DATA")
            else:
                print("âš   Nie znaleziono poczÄ…tku PROFILES_DATA")
        else:
            # Nowy marker
            if "</script>" in html:
                html = html.replace("</script>", f"\n{inject_pd}\n</script>", 1)
                print("âœ“ Profiles data dodana (nowy marker)")
except Exception as e:
    print(f"âš   BÅ‚Ä…d wstrzykiwania PROFILES_DATA: {e}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Zapisz zaktualizowany HTML
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    with open("olx_dashboard.html", "w", encoding="utf-8") as f:
        f.write(html)
    print(f"âœ… Dashboard zaktualizowany â€“ {len(history)} ogÅ‚oszeÅ„, rynek: {market_total}")
except Exception as e:
    print(f"âŒ BÅ‚Ä…d zapisu dashboard: {e}")
    sys.exit(1)
PYEOF

      - name: Zapisz dane do repozytorium
        run: |
          git config user.name  "OLX Monitor Bot"
          git config user.email "bot@github-actions"
          git add data/olx_monitoring.xlsx     || true
          git add data/price_history.json      || true
          git add data/profiles_state.json     || true
          git add data/last_run.json           || true
          git add olx_dashboard.html           || true
          
          # SprawdÅº czy sÄ… zmiany
          if git diff --cached --quiet; then
            echo "â„¹  Brak zmian do zapisania"
            exit 0
          fi
          
          git commit -m "ğŸ“Š OLX Monitor $(date +'%Y-%m-%d %H:%M')"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Push z retry
          for attempt in 1 2 3; do
            echo "Push attempt $attempt..."
            if git push origin main; then
              echo "âœ… Push powiÃ³dÅ‚ siÄ™"
              exit 0
            fi
            if [ $attempt -lt 3 ]; then
              echo "âš   Push failed, retry za 10s..."
              sleep 10
            fi
          done
          
          echo "âŒ Push failed po 3 prÃ³bach"
          exit 1

      - name: Notyfikacja w przypadku bÅ‚Ä™du
        if: failure()
        run: |
          echo "âŒ Workflow nie powiÃ³dÅ‚ siÄ™"
          echo "SprawdÅº logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
