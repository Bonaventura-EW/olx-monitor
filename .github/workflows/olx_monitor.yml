name: OLX Monitor â€“ codzienny raport

on:
  schedule:
    - cron: "0 7 * * *"   # 09:00 czasu polskiego (UTC+2)
  workflow_dispatch:
    inputs:
      force_email:
        description: 'WymuÅ› wysyÅ‚kÄ™ e-maila (niezaleÅ¼nie od dnia tygodnia)'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repozytorium
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ustaw Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Zainstaluj zaleÅ¼noÅ›ci
        run: pip install -r requirements.txt

      - name: Uruchom OLX Monitor (scraping)
        run: python olx_monitor.py

      - name: WyÅ›lij tygodniowy raport e-mail
        run: |
          DAY=$(date +%u)
          FORCE="${{ github.event.inputs.force_email }}"
          if [ "$DAY" = "1" ] || [ "$FORCE" = "true" ]; then
            echo "ðŸ“§ WysyÅ‚am tygodniowy raport e-mail..."
            python email_report.py
          else
            echo "â­  Nie poniedziaÅ‚ek (dzieÅ„ $DAY) â€“ pomijam e-mail."
          fi
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: PokaÅ¼ wyniki (summary)
        run: |
          echo "## ðŸ“Š OLX Monitor â€“ wyniki $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          if [ -f data/last_run.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat data/last_run.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Zaktualizuj dashboard (wstrzyknij Å›wieÅ¼e dane do HTML)
        run: |
          if [ -f data/price_history.json ]; then
            python - << 'PYEOF'
          import json, re, os

          with open("data/price_history.json", "r", encoding="utf-8") as f:
              history = json.load(f)

          market_total = None
          if os.path.exists("data/last_run.json"):
              with open("data/last_run.json", "r", encoding="utf-8") as f:
                  last_run = json.load(f)
              market_total = last_run.get("market_total")

          with open("olx_dashboard.html", "r", encoding="utf-8") as f:
              html = f.read()

          # Wstrzyknij PRICE_HISTORY
          inject_ph = f"window.__PRICE_HISTORY__ = {json.dumps(history, ensure_ascii=False)};"
          if "window.__PRICE_HISTORY__" in html:
              html = re.sub(
                  r"window\.__PRICE_HISTORY__\s*=\s*\{.*?\};",
                  inject_ph,
                  html, flags=re.DOTALL
              )
          else:
              html = html.replace("</script>", "\n" + inject_ph + "\n</script>", 1)

          # Wstrzyknij MARKET_TOTAL
          if market_total is not None:
              inject_mt = f"window.__MARKET_TOTAL__ = {market_total};"
              if "window.__MARKET_TOTAL__" in html:
                  html = re.sub(r"window\.__MARKET_TOTAL__\s*=\s*\d+;", inject_mt, html)
              else:
                  html = html.replace("</script>", "\n" + inject_mt + "\n</script>", 1)

          with open("olx_dashboard.html", "w", encoding="utf-8") as f:
              f.write(html)

          print(f"âœ… Dashboard zaktualizowany â€” {len(history)} ogÅ‚oszeÅ„, rynek OLX: {market_total}")
          PYEOF
          else
            echo "âš   Brak data/price_history.json â€“ dashboard bez wstrzykniÄ™tych danych"
          fi

      - name: Zapisz dane do repozytorium
        run: |
          git config user.name  "OLX Monitor Bot"
          git config user.email "bot@github-actions"
          git add data/olx_monitoring.xlsx
          git add data/price_history.json   || true
          git add data/last_run.json        || true
          git add olx_dashboard.html        || true
          git diff --cached --quiet && echo "Brak zmian do zapisania" && exit 0
          git commit -m "ðŸ“Š OLX Monitor $(date +'%Y-%m-%d %H:%M')"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Bonaventura-EW/olx-monitor.git
          git push origin main
