name: OLX Monitor ‚Äì codzienny raport

on:
  schedule:
    - cron: "0 7 * * *"   # 09:00 czasu polskiego (UTC+2)
  workflow_dispatch:
    inputs:
      force_email:
        description: 'Wymu≈õ wysy≈Çkƒô e-maila (niezale≈ºnie od dnia tygodnia)'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repozytorium
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ustaw Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Zainstaluj zale≈ºno≈õci
        run: pip install -r requirements.txt

      - name: Uruchom OLX Monitor (scraping)
        run: python olx_monitor.py

      - name: Wy≈õlij tygodniowy raport e-mail
        run: |
          DAY=$(date +%u)
          FORCE="${{ github.event.inputs.force_email }}"
          if [ "$DAY" = "1" ] || [ "$FORCE" = "true" ]; then
            echo "üìß Wysy≈Çam tygodniowy raport e-mail..."
            python email_report.py
          else
            echo "‚è≠  Nie poniedzia≈Çek (dzie≈Ñ $DAY) ‚Äì pomijam e-mail."
          fi
        env:
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Poka≈º wyniki (summary)
        run: |
          echo "## üìä OLX Monitor ‚Äì wyniki $(date +'%Y-%m-%d')" >> $GITHUB_STEP_SUMMARY
          if [ -f data/last_run.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat data/last_run.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Zaktualizuj dashboard (wstrzyknij ≈õwie≈ºe dane do HTML)
        run: |
          # B≈ÅƒÑD 13: Sprawd≈∫ istnienie plik√≥w przed przetwarzaniem
          if [ ! -f olx_dashboard.html ]; then
            echo "‚ö†  Brak olx_dashboard.html ‚Äì pomijam aktualizacjƒô dashboard"
            exit 0
          fi
          
          if [ -f data/price_history.json ]; then
            python - << 'PYEOF'
          import json, re, os

          # Wczytaj price_history
          with open("data/price_history.json", "r", encoding="utf-8") as f:
              history = json.load(f)

          # Wczytaj market_total z last_run.json
          market_total = None
          if os.path.exists("data/last_run.json"):
              with open("data/last_run.json", "r", encoding="utf-8") as f:
                  last_run = json.load(f)
              market_total = last_run.get("market_total")

          with open("olx_dashboard.html", "r", encoding="utf-8") as f:
              html = f.read()

          # Wstrzyknij PRICE_HISTORY
          inject_ph = f"window.__PRICE_HISTORY__ = {json.dumps(history, ensure_ascii=False)};"
          if "window.__PRICE_HISTORY__" in html:
              html = re.sub(
                  r"window\.__PRICE_HISTORY__\s*=\s*\{.*?\};",
                  inject_ph,
                  html, flags=re.DOTALL
              )
          else:
              html = html.replace("</script>", "\n" + inject_ph + "\n</script>", 1)

          # Wstrzyknij MARKET_TOTAL
          if market_total is not None:
              inject_mt = f"window.__MARKET_TOTAL__ = {market_total};"
              if "window.__MARKET_TOTAL__" in html:
                  html = re.sub(r"window\.__MARKET_TOTAL__\s*=\s*\d+;", inject_mt, html)
              else:
                  html = html.replace("</script>", "\n" + inject_mt + "\n</script>", 1)

          # Wstrzyknij LAST_RUN (czas ostatniego skanu)
          if os.path.exists("data/last_run.json"):
              with open("data/last_run.json", "r", encoding="utf-8") as f_lr:
                  last_run_data = json.load(f_lr)
              run_at = last_run_data.get("run_at", "")
              if run_at:
                  inject_lr = f'window.__LAST_RUN__ = "{run_at}";'
                  if "window.__LAST_RUN__" in html:
                      html = re.sub(r'window\.__LAST_RUN__\s*=\s*[^;]+;', inject_lr, html)
                  else:
                      html = html.replace("</script>", "\n" + inject_lr + "\n</script>", 1)

          # B≈ÅƒÑD 12: Wstrzyknij PROFILES_DATA z poprawionƒÖ obs≈ÇugƒÖ wieloliniowego JSON
          if os.path.exists("data/profiles_state.json"):
              with open("data/profiles_state.json", "r", encoding="utf-8") as f_ps:
                  profiles_state = json.load(f_ps)
              inject_pd = f"window.__PROFILES_DATA__ = {json.dumps(profiles_state, ensure_ascii=False)};"
              
              if "window.__PROFILES_DATA__" in html:
                  # U≈ºyj DOTALL do obs≈Çugi wieloliniowego JSON
                  html = re.sub(
                      r"window\.__PROFILES_DATA__\s*=\s*(?:null|\{.*?\});",
                      inject_pd,
                      html,
                      flags=re.DOTALL
                  )
                  
                  # FALLBACK: Je≈õli regex nie zadzia≈Ça≈Ç (wielopoziomowy JSON)
                  if inject_pd not in html and "window.__PROFILES_DATA__" in html:
                      # Znajd≈∫ poczƒÖtek i koniec deklaracji
                      start = html.find("window.__PROFILES_DATA__ = ")
                      if start != -1:
                          end = html.find(";", start)
                          if end != -1:
                              html = html[:start] + inject_pd + html[end+1:]
              else:
                  html = html.replace("</script>", "\n" + inject_pd + "\n</script>", 1)

          with open("olx_dashboard.html", "w", encoding="utf-8") as f:
              f.write(html)

          print(f"‚úÖ Dashboard zaktualizowany ‚Äî {len(history)} og≈Çosze≈Ñ, rynek OLX: {market_total}")
          PYEOF
          else
            echo "‚ö†  Brak data/price_history.json ‚Äì dashboard bez wstrzykniƒôtych danych"
          fi

      - name: Zapisz dane do repozytorium
        run: |
          git config user.name  "OLX Monitor Bot"
          git config user.email "bot@github-actions"
          git add data/olx_monitoring.xlsx     || true
          git add data/price_history.json      || true
          git add data/profiles_state.json     || true
          git add data/last_run.json           || true
          git add olx_dashboard.html           || true
          git diff --cached --quiet && echo "Brak zmian do zapisania" && exit 0
          git commit -m "üìä OLX Monitor $(date +'%Y-%m-%d %H:%M')"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/Bonaventura-EW/olx-monitor.git
          git push origin main
